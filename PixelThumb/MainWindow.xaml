<Window x:Class="PixelThumb.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:vwp="clr-namespace:WpfToolkit.Controls;assembly=VirtualizingWrapPanel"
        xmlns:vm="clr-namespace:PixelThumb.ViewModels"
        xmlns:local="clr-namespace:PixelThumb.Converters"
        Title="PixelThumb - Pixel Art Thumbnail Viewer"
        Height="700" Width="1000"
        MinHeight="400" MinWidth="600"
        WindowStartupLocation="CenterScreen"
        Background="#1E1E1E">

    <Window.DataContext>
        <vm:MainViewModel/>
    </Window.DataContext>

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <local:BindingProxy x:Key="Proxy" Data="{Binding}"/>
        <local:ImageScaleMultiConverter x:Key="ImageScaleConverter"/>
    </Window.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="Auto"/>
        </Grid.RowDefinitions>

        <!-- Toolbar -->
        <Border Grid.Row="0" Background="#2D2D2D" Padding="8">
            <DockPanel>
                <Button DockPanel.Dock="Left"
                        Content="Open Folder"
                        Command="{Binding SelectFolderCommand}"
                        Padding="12,6"
                        FontSize="13"
                        Background="#0078D4"
                        Foreground="White"
                        BorderThickness="0"
                        Cursor="Hand"/>

                <StackPanel DockPanel.Dock="Right" Orientation="Horizontal" VerticalAlignment="Center" Margin="16,0,0,0">
                    <CheckBox Content="Fit Small"
                              IsChecked="{Binding FitSmallImages}"
                              Foreground="#CCC"
                              VerticalAlignment="Center"
                              Margin="0,0,12,0"
                              FontSize="11"
                              ToolTip="When checked, small images are scaled up to fill the thumbnail"/>
                    <CheckBox Content="Fit Large"
                              IsChecked="{Binding FitLargeImages}"
                              Foreground="#CCC"
                              VerticalAlignment="Center"
                              Margin="0,0,12,0"
                              FontSize="11"
                              ToolTip="When checked, large images are scaled down to fit the thumbnail"/>
                    <StackPanel Orientation="Horizontal" VerticalAlignment="Center" Margin="0,0,12,0">
                        <StackPanel.Style>
                            <Style TargetType="StackPanel">
                                <Setter Property="IsEnabled" Value="True"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding FitSmallImages}" Value="True">
                                        <Setter Property="IsEnabled" Value="False"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </StackPanel.Style>
                        <TextBlock Text="Scale:" Foreground="#CCC" VerticalAlignment="Center" Margin="0,0,6,0" FontSize="12"/>
                        <Slider Width="100"
                                Minimum="1" Maximum="16"
                                Value="{Binding PixelScale}"
                                VerticalAlignment="Center"
                                SmallChange="1" LargeChange="4"
                                IsSnapToTickEnabled="True" TickFrequency="1"/>
                        <TextBlock Text="{Binding PixelScale, StringFormat={}{0}x}"
                                   Foreground="#CCC" VerticalAlignment="Center" Margin="6,0,0,0" FontSize="12" Width="28"/>
                    </StackPanel>
                    <TextBlock Text="Size:" Foreground="#CCC" VerticalAlignment="Center" Margin="0,0,6,0" FontSize="12"/>
                    <Slider Width="200"
                            Minimum="32" Maximum="512"
                            Value="{Binding ThumbnailSize}"
                            VerticalAlignment="Center"
                            SmallChange="8" LargeChange="32"
                            TickFrequency="32" IsSnapToTickEnabled="False"/>
                    <TextBlock Text="{Binding ThumbnailSize, StringFormat={}{0:F0}px}"
                               Foreground="#CCC" VerticalAlignment="Center" Margin="8,0,0,0" FontSize="12" Width="45"/>
                </StackPanel>

                <TextBlock DockPanel.Dock="Left"
                           Text="{Binding CurrentFolder}"
                           Foreground="#999"
                           VerticalAlignment="Center"
                           Margin="12,0,0,0"
                           FontSize="11"
                           TextTrimming="CharacterEllipsis"/>
            </DockPanel>
        </Border>

        <!-- Image Grid -->
        <ListBox x:Name="ImageListBox"
                 Grid.Row="1"
                 ItemsSource="{Binding Images}"
                 Background="Transparent"
                 BorderThickness="0"
                 ScrollViewer.HorizontalScrollBarVisibility="Disabled"
                 ScrollViewer.VerticalScrollBarVisibility="Auto"
                 ScrollViewer.CanContentScroll="True"
                 VirtualizingPanel.IsVirtualizing="True"
                 VirtualizingPanel.VirtualizationMode="Recycling"
                 VirtualizingPanel.ScrollUnit="Pixel"
                 SelectionMode="Single"
                 HorizontalContentAlignment="Left">
            <ListBox.ItemsPanel>
                <ItemsPanelTemplate>
                    <vwp:VirtualizingWrapPanel Orientation="Horizontal"
                                               SpacingMode="Uniform"/>
                </ItemsPanelTemplate>
            </ListBox.ItemsPanel>
            <ListBox.ItemContainerStyle>
                <Style TargetType="ListBoxItem">
                    <Setter Property="Padding" Value="4"/>
                    <Setter Property="Margin" Value="2"/>
                    <Setter Property="Background" Value="Transparent"/>
                    <Setter Property="BorderThickness" Value="0"/>
                    <Setter Property="HorizontalContentAlignment" Value="Center"/>
                    <Setter Property="Template">
                        <Setter.Value>
                            <ControlTemplate TargetType="ListBoxItem">
                                <Border x:Name="Bd"
                                        Background="#2A2A2A"
                                        CornerRadius="4"
                                        Padding="4"
                                        Margin="2"
                                        BorderThickness="2"
                                        BorderBrush="Transparent">
                                    <ContentPresenter/>
                                </Border>
                                <ControlTemplate.Triggers>
                                    <Trigger Property="IsMouseOver" Value="True">
                                        <Setter TargetName="Bd" Property="BorderBrush" Value="#555"/>
                                    </Trigger>
                                    <Trigger Property="IsSelected" Value="True">
                                        <Setter TargetName="Bd" Property="BorderBrush" Value="#0078D4"/>
                                    </Trigger>
                                </ControlTemplate.Triggers>
                            </ControlTemplate>
                        </Setter.Value>
                    </Setter>
                </Style>
            </ListBox.ItemContainerStyle>
            <ListBox.ItemTemplate>
                <DataTemplate>
                    <StackPanel Width="{Binding DataContext.ThumbnailSize, RelativeSource={RelativeSource AncestorType=Window}}">
                        <StackPanel.ContextMenu>
                            <ContextMenu>
                                <MenuItem Header="{Binding FileName}" IsEnabled="False" FontWeight="Bold"/>
                                <MenuItem IsEnabled="False">
                                    <MenuItem.Header>
                                        <TextBlock>
                                            <Run Text="{Binding PixelWidth, Mode=OneWay}"/><Run Text=" x "/><Run Text="{Binding PixelHeight, Mode=OneWay}"/><Run Text="  |  "/><Run Text="{Binding FileSizeText, Mode=OneWay}"/>
                                        </TextBlock>
                                    </MenuItem.Header>
                                </MenuItem>
                                <Separator/>
                                <MenuItem Header="Show in Explorer"
                                          Command="{Binding Data.OpenInExplorerCommand, Source={StaticResource Proxy}}"
                                          CommandParameter="{Binding}"/>
                            </ContextMenu>
                        </StackPanel.ContextMenu>
                        <Border Background="#1A1A1A"
                                Width="{Binding DataContext.ThumbnailSize, RelativeSource={RelativeSource AncestorType=Window}}"
                                Height="{Binding DataContext.ThumbnailSize, RelativeSource={RelativeSource AncestorType=Window}}"
                                ClipToBounds="True">
                            <Image Source="{Binding Thumbnail}"
                                   RenderOptions.BitmapScalingMode="NearestNeighbor"
                                   Stretch="None"
                                   HorizontalAlignment="Center"
                                   VerticalAlignment="Center"
                                   SnapsToDevicePixels="True"
                                   UseLayoutRounding="True">
                                <Image.LayoutTransform>
                                    <ScaleTransform>
                                        <ScaleTransform.ScaleX>
                                            <MultiBinding Converter="{StaticResource ImageScaleConverter}">
                                                <Binding Path="PixelWidth"/>
                                                <Binding Path="PixelHeight"/>
                                                <Binding Path="DataContext.FitSmallImages" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="DataContext.FitLargeImages" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="DataContext.PixelScale" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="DataContext.ThumbnailSize" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                            </MultiBinding>
                                        </ScaleTransform.ScaleX>
                                        <ScaleTransform.ScaleY>
                                            <MultiBinding Converter="{StaticResource ImageScaleConverter}">
                                                <Binding Path="PixelWidth"/>
                                                <Binding Path="PixelHeight"/>
                                                <Binding Path="DataContext.FitSmallImages" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="DataContext.FitLargeImages" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="DataContext.PixelScale" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                                <Binding Path="DataContext.ThumbnailSize" RelativeSource="{RelativeSource AncestorType=Window}"/>
                                            </MultiBinding>
                                        </ScaleTransform.ScaleY>
                                    </ScaleTransform>
                                </Image.LayoutTransform>
                            </Image>
                        </Border>
                        <TextBlock Text="{Binding FileName}"
                                   Foreground="#BBB"
                                   FontSize="10"
                                   TextTrimming="CharacterEllipsis"
                                   HorizontalAlignment="Center"
                                   Margin="0,3,0,0"
                                   TextAlignment="Center"/>
                    </StackPanel>
                </DataTemplate>
            </ListBox.ItemTemplate>
        </ListBox>

        <!-- Loading Indicator -->
        <ProgressBar Grid.Row="1"
                     IsIndeterminate="True"
                     Height="3"
                     VerticalAlignment="Top"
                     Visibility="{Binding IsLoading, Converter={StaticResource BoolToVis}}"
                     Background="Transparent"
                     Foreground="#0078D4"
                     BorderThickness="0"/>

        <!-- Status Bar -->
        <Border Grid.Row="2" Background="#2D2D2D" Padding="8,4">
            <TextBlock Text="{Binding StatusText}" Foreground="#AAA" FontSize="11"/>
        </Border>
    </Grid>
</Window>
